# Grepa Monorepo – Specification (v0.1)

> **Goal:** Enhance the grepa ecosystem with interactive initialization, performance optimizations, ESLint integration, and comprehensive documentation site.

---

## 1 Overview

Version 0.1 builds upon the v0 foundation to add:
- Interactive `grepa init` command for project setup
- Performance optimizations with caching and streaming
- ESLint plugin for JavaScript/TypeScript projects
- Cookbook repository with integration examples
- Nextra-based documentation site

---

## 2 Feature: Interactive Initialization

### 2.1 Command Interface

```bash
$ grepa init

Welcome to Grepa! Let's set up grep-anchors for your project.

? What anchor would you like to use? (default: ga) › my-tag
? Enable pre-commit hooks? (Y/n) › Yes
? Select hook manager: › Husky
  ○ Husky
  ○ Lefthook
  ○ pre-commit
  ○ None

✓ Created .grepa.yml
✓ Installed husky hook
✓ Ready to use grep-anchors with :my-tag:
```

### 2.2 Anchor Validation Rules

- Accept: `a-z`, `A-Z`, `0-9`, `-`, `_`
- Reject: `:`, spaces, special characters
- Length: 1-20 characters
- Case-insensitive (stored as lowercase)

### 2.3 Generated .grepa.yml

```yaml
# Generated by grepa init
anchor: ":my-tag:"

files:
  include:
    - "**/*.{js,ts,jsx,tsx}"
    - "**/*.{py,rb,go,rs}"
    - "**/*.{html,css,scss}"
  exclude:
    - "**/node_modules/**"
    - "**/dist/**"
    - "**/.git/**"

lint:
  forbid: ["temp", "debug"]
  maxAgeDays: 90

dictionary:
  tldr: "Brief function/module summary"
  sec: "Security-sensitive code"
  perf: "Performance-critical section"
  todo: "Future work"
  fixme: "Known issue"
```

### 2.4 Hook Installation

Support automatic installation for:
- **Husky**: Create `.husky/pre-commit` with grepa lint
- **Lefthook**: Update `lefthook.yml` with grepa stage
- **pre-commit**: Add `.pre-commit-config.yaml` entry

---

## 3 Feature: Performance Optimizations

### 3.1 Git-based Caching

Cache scan results keyed by `git rev-parse HEAD`:

```typescript
interface CacheEntry {
  gitHash: string;
  timestamp: number;
  anchors: Anchor[];
  fileHashes: Record<string, string>;
}

// Cache location: .grepa/cache/
// Invalidate on: file changes, config changes
```

### 3.2 Ripgrep JSON Streaming

Replace multiple ripgrep calls with single streaming parse:

```typescript
// Before: Multiple forks
const files = await execRipgrep(['--files', ...patterns]);
for (const file of files) {
  const matches = await execRipgrep([':ga:', file]);
}

// After: Single streaming process
const rg = spawn('rg', ['--json', ':ga:', ...patterns]);
rg.stdout.pipe(new JSONStreamParser())
  .on('match', (match) => processAnchor(match));
```

### 3.3 Incremental Updates

Only re-scan changed files since last cache:

```typescript
// Get changed files
const changed = await git.diff('HEAD', cache.gitHash);
const unchanged = cache.anchors.filter(a => !changed.includes(a.file));
const updated = await scanFiles(changed);
return [...unchanged, ...updated];
```

---

## 4 Feature: Cookbook Repository

### 4.1 Repository Structure

```
grepa-cookbook/
├── README.md
├── ci-cd/
│   ├── github-actions/
│   │   ├── basic-lint.yml
│   │   ├── matrix-lint.yml
│   │   └── pr-comment.yml
│   ├── gitlab-ci/
│   │   └── .gitlab-ci.yml
│   └── jenkins/
│       └── Jenkinsfile
├── hooks/
│   ├── husky/
│   │   ├── .huskyrc.js
│   │   └── pre-commit
│   ├── lefthook/
│   │   └── lefthook.yml
│   └── pre-commit/
│       └── .pre-commit-config.yaml
├── editor-config/
│   ├── vscode/
│   │   └── settings.json
│   └── vim/
│       └── .vimrc
└── examples/
    ├── typescript-react/
    ├── python-django/
    └── go-microservice/
```

### 4.2 GitHub Actions Example

```yaml
# .github/workflows/grepa-lint.yml
name: Lint Grep Anchors

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install grepa
        run: npm install -g @grepa/cli
        
      - name: Run grepa lint
        run: grepa lint --ci
        
      - name: Comment PR (optional)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = require('./grepa-output.json');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Grep anchor violations found:\n' + output.summary
            });
```

---

## 5 Feature: ESLint Plugin

### 5.1 Package Structure

```
packages/eslint-plugin/
├── src/
│   ├── index.ts
│   ├── rules/
│   │   ├── no-temp-anchor.ts
│   │   ├── no-debug-anchor.ts
│   │   ├── prefer-ga-tag.ts
│   │   └── format-todo-comments.ts
│   └── utils/
│       ├── anchor-parser.ts
│       └── config-loader.ts
├── tests/
│   └── rules/
└── package.json
```

### 5.2 Rule Implementations

#### `no-temp-anchor`
```typescript
// Flags: // :ga:temp
// Message: "Temporary anchors are not allowed"
// Fixable: No
```

#### `no-debug-anchor`
```typescript
// Flags: // :ga:debug
// Message: "Debug anchors must be removed before commit"
// Fixable: No
```

#### `prefer-ga-tag`
```typescript
// Flags: // TODO: something
// Suggests: // :ga:todo something
// Fixable: Yes (autofix available)
```

#### `format-todo-comments`
```typescript
// Transforms:
//   // TODO: implement caching
//   // FIXME: handle edge case
// Into:
//   // :ga:todo implement caching
//   // :ga:fixme handle edge case
// Fixable: Yes
```

### 5.3 Configuration

```javascript
// .eslintrc.js
module.exports = {
  plugins: ['@grepa'],
  rules: {
    '@grepa/no-temp-anchor': 'error',
    '@grepa/no-debug-anchor': 'error',
    '@grepa/prefer-ga-tag': 'warn',
    '@grepa/format-todo-comments': ['warn', {
      autofix: true,
      anchor: 'ga' // Read from .grepa.yml
    }]
  }
};
```

---

## 6 Feature: Documentation Site (Nextra)

### 6.1 Site Structure

```
packages/docs/
├── pages/
│   ├── index.mdx          # Landing page
│   ├── getting-started.mdx
│   ├── installation.mdx
│   ├── commands/
│   │   ├── init.mdx
│   │   ├── list.mdx
│   │   ├── grep.mdx
│   │   ├── lint.mdx
│   │   ├── stats.mdx
│   │   └── format.mdx
│   ├── configuration.mdx
│   ├── integrations/
│   │   ├── eslint.mdx
│   │   ├── ci-cd.mdx
│   │   └── editors.mdx
│   ├── cookbook/
│   │   └── _meta.json
│   └── api/
│       ├── core.mdx
│       └── cli.mdx
├── theme.config.tsx
├── next.config.js
└── package.json
```

### 6.2 Deployment Configuration

- **Domain**: `docs.grepa.dev`
- **Platform**: Vercel (automatic from GitHub)
- **Features**:
  - Search (Algolia DocSearch)
  - Dark mode support
  - Interactive examples
  - API playground

### 6.3 Content Requirements

- Quick start guide with animated terminal recordings
- Interactive anchor playground
- Integration guides for popular frameworks
- Video tutorials for common workflows
- Searchable token dictionary

---

## 7 Implementation Plan

### Phase 1: Interactive Init (Week 1)
- [ ] Create interactive prompts with `inquirer`
- [ ] Implement anchor validation
- [ ] Add hook installation logic
- [ ] Update CLI with `init` command

### Phase 2: Performance (Week 2)
- [ ] Implement git-based cache system
- [ ] Add ripgrep JSON streaming
- [ ] Create incremental scan logic
- [ ] Add cache invalidation

### Phase 3: ESLint Plugin (Week 3)
- [ ] Set up plugin package structure
- [ ] Implement four rules
- [ ] Add comprehensive tests
- [ ] Create rule documentation

### Phase 4: Cookbook & Examples (Week 4)
- [ ] Create cookbook repository
- [ ] Add CI/CD examples
- [ ] Create hook configurations
- [ ] Document best practices

### Phase 5: Documentation Site (Week 5-6)
- [ ] Set up Nextra site
- [ ] Migrate existing docs
- [ ] Create interactive examples
- [ ] Configure deployment

---

## 8 Success Criteria

1. **Init Command**
   - Interactive flow completes without errors
   - Generated config is valid
   - Hooks install correctly

2. **Performance**
   - 50%+ speed improvement on large repos
   - Cache hit rate > 90%
   - Memory usage remains constant

3. **ESLint Plugin**
   - All rules have 95%+ test coverage
   - Autofix works reliably
   - No false positives

4. **Documentation**
   - Site loads in < 2s
   - Search returns relevant results
   - Examples are copy-pasteable

---

## 9 Migration Guide

### From v0 to v0.1

1. **Update CLI**
   ```bash
   npm update -g @grepa/cli
   ```

2. **Run init in existing projects**
   ```bash
   grepa init --migrate
   ```

3. **Add ESLint plugin**
   ```bash
   npm install -D @grepa/eslint-plugin
   ```

4. **Update CI/CD**
   - Add caching directories
   - Update action versions

---

#### End of spec v0.1